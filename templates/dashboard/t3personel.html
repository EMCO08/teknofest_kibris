{% extends 'base.html' %}

{% block title %}T3 Personel Verileri - Yemek Otomasyonu{% endblock %}

{% block extra_css %}
<style>
    .analysis-card {
        margin-bottom: 30px;
    }
    
    .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
        margin-bottom: 20px;
    }
    
    .chart-title {
        font-size: 1.25rem;
        margin-bottom: 15px;
        color: var(--teknofest-blue);
        font-weight: bold;
    }
    
    .btn-chart-toggle {
        margin-right: 5px;
        margin-bottom: 10px;
    }
    
    .date-selector {
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Genel Analiz Kartı -->
<div class="card shadow-lg fade-in analysis-card">
    <div class="card-header bg-primary text-white">
        <h3 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Genel Analiz</h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-12">
                <div class="date-selector mb-4">
                    <label class="form-label">Tarih seçin:</label>
                    <select id="dateSelect" class="form-select">
                        {% for tarih in tarihler %}
                            <option value="{{ tarih }}">{{ tarih }}</option>
                        {% endfor %}
                    </select>
                </div>
                <h4 class="chart-title">Koordinatörlük Bazında Toplam Yemek Siparişleri</h4>
                <div class="chart-container">
                    <canvas id="koordinatorlukChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- T3 Personel Verileri Kartı -->
<div class="card shadow-lg fade-in mb-4">
    <div class="card-header bg-primary text-white">
        <h3 class="mb-0"><i class="fas fa-users me-2"></i>T3 Personel Verileri</h3>
    </div>
    <div class="card-body">
        <form method="get" class="mb-4">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="baslangic_tarihi" class="form-label">Başlangıç Tarihi</label>
                    <input type="date" class="form-control" id="baslangic_tarihi" name="baslangic_tarihi" value="{{ filtreler.baslangic_tarihi }}">
                </div>
                <div class="col-md-3">
                    <label for="bitis_tarihi" class="form-label">Bitiş Tarihi</label>
                    <input type="date" class="form-control" id="bitis_tarihi" name="bitis_tarihi" value="{{ filtreler.bitis_tarihi }}">
                </div>
                <div class="col-md-3">
                    <label for="koordinatorluk" class="form-label">Koordinatörlük</label>
                    <select class="form-select" id="koordinatorluk" name="koordinatorluk">
                        <option value="">Tümü</option>
                        {% for k in koordinatorlukler %}
                            <option value="{{ k }}" {% if filtreler.koordinatorluk == k %}selected{% endif %}>{{ k }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="birim" class="form-label">Birim</label>
                    <select class="form-select" id="birim" name="birim">
                        <option value="">Tümü</option>
                        {% for b in birimler %}
                            <option value="{{ b }}" {% if filtreler.birim == b %}selected{% endif %}>{{ b }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12 d-flex justify-content-end">
                    <div class="form-check me-3">
                        <input class="form-check-input" type="checkbox" id="filtrele_0" name="filtrele_0">
                        <label class="form-check-label" for="filtrele_0">0 verilerini filtrele</label>
                    </div>
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-filter me-1"></i>Filtrele
                    </button>
                    <a href="?csv=1{% if filtreler.baslangic_tarihi %}&baslangic_tarihi={{ filtreler.baslangic_tarihi }}{% endif %}{% if filtreler.bitis_tarihi %}&bitis_tarihi={{ filtreler.bitis_tarihi }}{% endif %}{% if filtreler.koordinatorluk %}&koordinatorluk={{ filtreler.koordinatorluk }}{% endif %}{% if filtreler.birim %}&birim={{ filtreler.birim }}{% endif %}" class="btn btn-success">
                        <i class="fas fa-download me-1"></i>Excel İndir
                    </a>
                </div>
            </div>
        </form>

        <div class="table-responsive">
            <table class="table table-striped table-hover" id="t3personel_table">
                <thead class="table-dark">
                    <tr>
                        <th>İsim</th>
                        <th>Koordinatörlük</th>
                        <th>Birim</th>
                        <th>Öğle Yemeği</th>
                        <th>Akşam Yemeği</th>
                        <th>Lunchbox</th>
                        <th>Coffee Break</th>
                        <th>Tarih</th>
                        <th>Saat</th>
                    </tr>
                </thead>
                <tbody>
                    {% for veri in veriler %}
                    <tr data-ogle="{{ veri.ogle_yemegi }}" data-aksam="{{ veri.aksam_yemegi }}" data-lunchbox="{{ veri.lunchbox }}" data-coffee="{{ veri.coffee_break }}">
                        <td>{{ veri.kisi.get_full_name }}</td>
                        <td>{{ veri.koordinatorluk }}</td>
                        <td>{{ veri.birim }}</td>
                        <td>{{ veri.ogle_yemegi }}</td>
                        <td>{{ veri.aksam_yemegi }}</td>
                        <td>{{ veri.lunchbox }}</td>
                        <td>{{ veri.coffee_break }}</td>
                        <td>{{ veri.submitteddate }}</td>
                        <td>{{ veri.submittedtime }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="text-center">Henüz veri bulunmamaktadır.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js kütüphanesi -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tablodaki 0 değerlerini filtreleme
    const filtreleCheckbox = document.getElementById('filtrele_0');
    const table = document.getElementById('t3personel_table');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

    filtreleCheckbox.addEventListener('change', function() {
        for (let row of rows) {
            if (row.cells.length > 1) { // Boş satır değilse
                const ogle = parseInt(row.dataset.ogle);
                const aksam = parseInt(row.dataset.aksam);
                const lunchbox = parseInt(row.dataset.lunchbox);
                const coffee = parseInt(row.dataset.coffee);
                
                if (this.checked && ogle === 0 && aksam === 0 && lunchbox === 0 && coffee === 0) {
                    row.style.display = 'none';
                } else {
                    row.style.display = '';
                }
            }
        }
    });
    
    // Analiz verileri
    const analiz_verileri = JSON.parse('{{ analiz_verileri|escapejs }}');
    const tarihler = JSON.parse('{{ tarihler|escapejs }}');
    
    // Renkleri tanımla
    const colors = [
        '#36a2eb', '#ff6384', '#4bc0c0', '#ffcd56', '#9966ff', '#ff9f40',
        '#00cc99', '#ff6666', '#6699ff', '#ffb366', '#99cc00', '#cc99ff',
        '#669900', '#0099cc', '#ff9999', '#cc0066', '#9999ff', '#006666'
    ];
    
    // Koordinatörlük grafiğini oluştur
    let koordinatorlukChart = null;
    
    function createKoordinatorlukChart(selectedDate) {
        // Eğer zaten bir grafik varsa, önce onu temizle
        if (koordinatorlukChart) {
            koordinatorlukChart.destroy();
        }
        
        const ctx = document.getElementById('koordinatorlukChart').getContext('2d');
        
        // Seçilen gün için verileri hazırla
        const koordinatorlukler = [];
        const yemekSayilari = [];
        
        for (const [koordinatorluk, gunVerileri] of Object.entries(analiz_verileri)) {
            if (selectedDate in gunVerileri) {
                koordinatorlukler.push(koordinatorluk);
                yemekSayilari.push(gunVerileri[selectedDate]);
            }
        }
        
        // Verileri azalan şekilde sırala
        let combinedData = koordinatorlukler.map((k, i) => ({
            koordinatorluk: k,
            yemek: yemekSayilari[i]
        }));
        
        combinedData.sort((a, b) => b.yemek - a.yemek);
        
        // Sıralanmış verileri tekrar ayır
        const sortedKoordinatorlukler = combinedData.map(d => d.koordinatorluk);
        const sortedYemekSayilari = combinedData.map(d => d.yemek);
        
        // Grafiği oluştur
        koordinatorlukChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sortedKoordinatorlukler,
                datasets: [{
                    label: 'Toplam Yemek Siparişi',
                    data: sortedYemekSayilari,
                    backgroundColor: colors.slice(0, sortedKoordinatorlukler.length),
                    borderColor: colors.slice(0, sortedKoordinatorlukler.length),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: selectedDate + ' Tarihli Koordinatörlük Bazında Toplam Yemek Siparişleri',
                        font: {
                            size: 16
                        }
                    },
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Toplam Yemek: ' + context.raw;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Yemek Sayısı'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Koordinatörlükler'
                        },
                        ticks: {
                            autoSkip: false,
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
    }
    
    // Tarih seçici değiştiğinde grafiği güncelle
    const dateSelect = document.getElementById('dateSelect');
    dateSelect.addEventListener('change', function() {
        createKoordinatorlukChart(this.value);
    });
    
    // İlk grafik oluşturma
    if (tarihler.length > 0) {
        createKoordinatorlukChart(tarihler[0]);
    }
});
</script>
{% endblock %}