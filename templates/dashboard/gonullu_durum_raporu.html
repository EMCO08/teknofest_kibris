{% extends 'base.html' %}

{% block title %}Gönüllü Durum Raporu - Yemek Otomasyonu{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-lg fade-in">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h3 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Gönüllü Durum Raporu</h3>
                <div>
                    <button id="exportToExcel" class="btn btn-success me-2">
                        <i class="fas fa-file-excel me-1"></i>Excel İndir
                    </button>
                    <a href="{% url 'dashboard:home' %}" class="btn btn-light">
                        <i class="fas fa-arrow-left me-1"></i>Dashboarda Dön
                    </a>
                </div>
            </div>
            <div class="card-body">
                <p>Bu sayfada gönüllülerin günlük durum raporlarını görüntüleyebilirsiniz.</p>
                
                <!-- Açıklama Kartı -->
                <div class="card bg-light mb-4">
                    <div class="card-body">
                        <h5 class="mb-3">Renk Açıklamaları:</h5>
                        <div class="d-flex flex-wrap">
                            <div class="me-4 mb-2">
                                <div class="d-flex align-items-center">
                                    <div class="bg-success me-2" style="width: 20px; height: 20px;"></div>
                                    <span>Geldi / 10.00'dan veya 15.30'dan önce</span>
                                </div>
                            </div>
                            <div class="me-4 mb-2">
                                <div class="d-flex align-items-center">
                                    <div class="bg-danger me-2" style="width: 20px; height: 20px;"></div>
                                    <span>Gelmedi / 10.00'dan veya 15.30'dan sonra</span>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="d-flex align-items-center">
                                    <div class="bg-light me-2" style="width: 20px; height: 20px; border: 1px solid #ccc;"></div>
                                    <span>Veri Girilmemiş</span>
                                </div>
                            </div>
                        </div>
                        <p class="mt-2 mb-0"><i class="fas fa-info-circle text-primary me-1"></i>Not: 09.00 kontrolü için 14.00'dan önce girilen son veri, 14.30 kontrolü için 14.00 ve sonrasında girilen son veri kullanılır.</p>
                    </div>
                </div>
                
                <!-- Tüm Günler İçin Ayrı Tablolar -->
                {% for gun in gunler %}
                <h4 class="mt-4 mb-3 text-center bg-info text-white p-2 rounded">{{ gun }}</h4>
                
                <!-- Durum Tablosu -->
                <div class="table-responsive mb-5">
                    <table class="table table-bordered table-hover excel-table" data-gun="{{ gun }}">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 180px;"></th>
                                {% for alan in alanlar %}
                                <th class="text-center" colspan="2">{{ alan }}</th>
                                {% endfor %}
                            </tr>
                            <tr>
                                <th></th>
                                {% for alan in alanlar %}
                                <th class="text-center">Gelme Durumu</th>
                                <th class="text-center">Geldiği Saat</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 09.00 Kontrolü -->
                            <tr>
                                <th class="bg-primary text-white align-middle">09.00 kontrolü</th>
                                {% for alan in alanlar %}
                                    {% with veri=gun_kontrol_verileri|dictitem:gun|dictitem:"09.00"|dictitem:alan %}
                                    <td class="text-center {{ veri.gelme_durumu_renk }}">
                                        {% if veri.gelme_durumu %}
                                            {{ veri.gelme_durumu }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="text-center {{ veri.gelme_saati_renk }}">
                                        {% if veri.gelme_saati %}
                                            {{ veri.gelme_saati }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    {% endwith %}
                                {% endfor %}
                            </tr>
                            
                            <!-- 14.30 Kontrolü -->
                            <tr>
                                <th class="bg-primary text-white align-middle">14.30 kontrolü</th>
                                {% for alan in alanlar %}
                                    {% with veri=gun_kontrol_verileri|dictitem:gun|dictitem:"14.30"|dictitem:alan %}
                                    <td class="text-center {{ veri.gelme_durumu_renk }}">
                                        {% if veri.gelme_durumu %}
                                            {{ veri.gelme_durumu }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="text-center {{ veri.gelme_saati_renk }}">
                                        {% if veri.gelme_saati %}
                                            {{ veri.gelme_saati }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    {% endwith %}
                                {% endfor %}
                            </tr>
                        </tbody>
                    </table>
                </div>
                {% endfor %}
                
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        console.log("Gönüllü durum raporu sayfası yüklendi.");
        
        // Excel indirme fonksiyonu
        $("#exportToExcel").on("click", function() {
            // SheetJS (xlsx) kütüphanesini yükle
            var script = document.createElement('script');
            script.src = "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";
            document.head.appendChild(script);
            
            script.onload = function() {
                var workbook = XLSX.utils.book_new();
                
                // Her gün için ayrı bir sayfa oluştur
                $(".excel-table").each(function() {
                    var gun = $(this).data("gun");
                    var table = $(this)[0];
                    
                    // Tablodaki verileri al, arka plan renkleri olmadan
                    var worksheet = XLSX.utils.table_to_sheet(table, {raw: true});
                    
                    // Sayfayı workbook'a ekle
                    XLSX.utils.book_append_sheet(workbook, worksheet, gun);
                });
                
                // Excel dosyasını indir
                XLSX.writeFile(workbook, "Gonullu_Durum_Raporu.xlsx");
            };
        });
    });
</script>
{% endblock %} 