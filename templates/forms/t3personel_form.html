{% extends 'base.html' %}
{% load form_filters %}

{% block title %}T3 Personel Sipariş Formu - Yemek Otomasyonu{% endblock %}

{% block extra_head %}
<!-- Başarı mesajı varsa 2 saniye sonra otomatik yönlendirme -->
{% if form_gonderildi %}
<meta http-equiv="refresh" content="2;url={% url 'forms:t3personel_form' %}">
{% endif %}
{% endblock %}

{% block content %}
<div class="card shadow-lg fade-in">
    <div class="card-header bg-primary text-white">
        <h3 class="mb-0"><i class="fas fa-utensils me-2"></i>T3 Personel Sipariş Formu</h3>
    </div>
    <div class="card-body">
        {% if form_gonderildi %}
        <!-- Başarı Mesajı - Ekran görüntüsündeki gibi stilize edilmiş -->
        <div id="success-message" class="text-center py-5 my-5">
            <div class="success-icon mb-4">
                <i class="fas fa-check"></i>
            </div>
            <h2 class="text-success">Verileriniz başarıyla gönderildi!</h2>
            
            <!-- Sayfa 2 saniye sonra otomatik olarak yönlendirilecek -->
            <div class="mt-3 text-muted small">
                <span id="redirect-seconds">2</span> saniye sonra ana sayfaya yönlendirileceksiniz...
            </div>
        </div>
        {% elif not saat_uygun %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Veri girişi için son saat {{ son_saat|stringformat:"02d" }}:{{ son_dakika|stringformat:"02d" }}'dır. Şu an veri girişi yapamazsınız.
        </div>
        {% endif %}
        
        {% if buton_goster and not form_gonderildi %}
        <!-- Buton Görünümü -->
        <div class="text-center my-5 py-5">
            <a href="?goster=form" class="btn btn-primary btn-lg px-5 py-3">
                <i class="fas fa-clipboard-list me-2"></i>T3 Personel Formu
            </a>
        </div>
        {% elif not form_gonderildi %}
            {% if not atamalar.exists %}
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Henüz size atanmış koordinatörlük ve birim bulunmamaktadır. Lütfen sistem yöneticisi ile iletişime geçin.
            </div>
            {% else %}
                {% if not form_goster and bugunku_kayitlar.exists %}
                <!-- Veri Görüntüleme Modu (Dikey Görünüm) -->
                <div class="alert alert-success mb-4">
                    <i class="fas fa-check-circle me-2"></i>
                    Bugün gönderdiğiniz verileri görmektesiniz.
                </div>
                
                <!-- Dikey kartlarda verileri göster -->
                <div class="row">
                    {% for veri in bugunku_kayitlar %}
                    <div class="col-md-12 mb-3">
                        <div class="card border-light h-100">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">{{ veri.koordinatorluk }} - {{ veri.birim }}</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <div class="data-item">
                                            <span class="data-label">Öğle Yemeği:</span>
                                            <span class="data-value">{{ veri.ogle_yemegi }}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="data-item">
                                            <span class="data-label">Akşam Yemeği:</span>
                                            <span class="data-value">{{ veri.aksam_yemegi }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="data-item">
                                            <span class="data-label">Lunchbox:</span>
                                            <span class="data-value">{{ veri.lunchbox }}</span>
                                        </div>
                                    </div>
                                    {% if veri.coffee_break > 0 %}
                                    <div class="col-md-6">
                                        <div class="data-item">
                                            <span class="data-label">Coffee Break:</span>
                                            <span class="data-value">{{ veri.coffee_break }}</span>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4">
                    {% if saat_uygun %}
                    <a href="{% url 'forms:t3personel_form_guncelle' %}" class="btn btn-warning btn-lg px-5">
                        <i class="fas fa-edit me-1"></i>Güncelle
                    </a>
                    {% endif %}
                </div>
                {% else %}
                <!-- Form Görüntüleme Modu -->
                {% if guncelleme_modu %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Bugünkü verileri düzenlemektesiniz.
                </div>
                {% else %}
                <div class="alert alert-info mb-4">
                    <i class="fas fa-clock me-2"></i>
                    Bugün {{ son_saat }}:00'e kadar veriler girilmelidir.
                </div>
                {% endif %}
                
                <form method="post" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    {% for atama in atamalar %}
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">{{ atama.koordinatorluk }} - {{ atama.birim }}</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label for="ogle_{{ atama.id }}" class="form-label">Öğle Yemeği</label>
                                    <input type="number" class="form-control" id="ogle_{{ atama.id }}" name="ogle_{{ atama.id }}" 
                                            min="0" value="{% if eski_veriler and atama.id in eski_veriler %}{{ eski_veriler|get_dict_item:atama.id|get_dict_item:'ogle' }}{% else %}0{% endif %}" 
                                            required {% if not saat_uygun %}disabled{% endif %}>
                                </div>
                                <div class="col-md-3">
                                    <label for="aksam_{{ atama.id }}" class="form-label">Akşam Yemeği</label>
                                    <input type="number" class="form-control" id="aksam_{{ atama.id }}" name="aksam_{{ atama.id }}" 
                                            min="0" value="{% if eski_veriler and atama.id in eski_veriler %}{{ eski_veriler|get_dict_item:atama.id|get_dict_item:'aksam' }}{% else %}0{% endif %}" 
                                            required {% if not saat_uygun %}disabled{% endif %}>
                                </div>
                                <div class="col-md-3">
                                    <label for="lunchbox_{{ atama.id }}" class="form-label">Lunchbox</label>
                                    <input type="number" class="form-control" id="lunchbox_{{ atama.id }}" name="lunchbox_{{ atama.id }}" 
                                            min="0" value="{% if eski_veriler and atama.id in eski_veriler %}{{ eski_veriler|get_dict_item:atama.id|get_dict_item:'lunchbox' }}{% else %}0{% endif %}" 
                                            required {% if not saat_uygun %}disabled{% endif %}>
                                </div>
                                {% if atama.coffee_break %}
                                <div class="col-md-3">
                                    <label for="coffee_{{ atama.id }}" class="form-label">Coffee Break</label>
                                    <input type="number" class="form-control" id="coffee_{{ atama.id }}" name="coffee_{{ atama.id }}" 
                                            min="0" value="{% if eski_veriler and atama.id in eski_veriler %}{{ eski_veriler|get_dict_item:atama.id|get_dict_item:'coffee' }}{% else %}0{% endif %}" 
                                            required {% if not saat_uygun %}disabled{% endif %}>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="submit" class="btn btn-primary" {% if not saat_uygun %}disabled{% endif %}>
                            <i class="fas fa-save me-1"></i>{% if guncelleme_modu %}Güncelle{% else %}Gönder{% endif %}
                        </button>
                    </div>
                </form>
                {% endif %}
            {% endif %}
        {% endif %}
    </div>
</div>

<style>
.data-item {
    padding: 8px 15px;
    border-radius: 4px;
    background-color: #f8f9fa;
    margin-bottom: 10px;
}
.data-label {
    font-weight: bold;
    color: #495057;
}
.data-value {
    font-size: 1.2em;
    margin-left: 8px;
    font-weight: 500;
    color: #000;
}
.success-icon {
    width: 70px;
    height: 70px;
    background-color: #28a745;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 15px;
}
.success-icon i {
    color: white;
    font-size: 40px;
}
</style>

<script>
// Sayfa yüklendiğinde
document.addEventListener('DOMContentLoaded', function() {
    // Saniye sayacı (eğer başarı sayfasındaysak)
    var redirectSeconds = document.getElementById('redirect-seconds');
    if (redirectSeconds) {
        var seconds = 2;
        var countInterval = setInterval(function() {
            seconds--;
            redirectSeconds.textContent = seconds;
            if (seconds <= 0) {
                clearInterval(countInterval);
                // JavaScript ile de yönlendirme deneyelim
                window.location.href = "{% url 'forms:t3personel_form' %}";
            }
        }, 1000);
    }

    // Yemek Otomasyonu başlığına tıklandığında
    var logoLinks = document.querySelectorAll('.navbar-brand');
    if (logoLinks.length > 0) {
        for (var i = 0; i < logoLinks.length; i++) {
            logoLinks[i].addEventListener('click', function(e) {
                // Sadece düzenleme sayfasında ise bu yönlendirmeyi yap
                if (!("{{ buton_goster }}" === "True") && ("{{ guncelleme_modu }}" === "True" || "{{ form_goster }}" === "True")) {
                    e.preventDefault();
                    window.location.href = "{% url 'forms:t3personel_form' %}?return_to_button=true";
                }
            });
        }
    }
    
    // Sunucudan gelen değeri al
    var saatUygun = "{{ saat_uygun }}" === "True";
    var submitButton = document.querySelector('button[type="submit"]');
    var updateButton = document.querySelector('a.btn-warning');
    
    if (submitButton) {
        submitButton.disabled = !saatUygun;
    }
    
    if (updateButton) {
        if (!saatUygun) {
            updateButton.classList.add('disabled');
            updateButton.setAttribute('aria-disabled', 'true');
        }
    }
    
    // Form alanlarının etkinliğini ayarla
    var inputs = document.querySelectorAll('input[type="number"]');
    for (var i = 0; i < inputs.length; i++) {
        inputs[i].disabled = !saatUygun;
    }
});
</script>

{% endblock %}